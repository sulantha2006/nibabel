<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Neuroimaging in Python &#8212; NiBabel 2.1.1dev documentation</title>
    
    <link rel="stylesheet" href="../_static/nibabel.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.1.1dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="NiBabel 2.1.1dev documentation" href="../index.html" />
    <link rel="up" title="DICOM concepts and implementations" href="dicom.html" />
    <link rel="next" title="DICOM Tags in the NIfTI Header" href="dicom_niftiheader.html" />
    <link rel="prev" title="Siemens format DICOM with CSA header" href="siemens_csa.html" />
  <meta name="keywords" content="nipy, neuroimaging, python, neuroscience">

  </head>
  <body role="document">
<div style="background-color: white; text-align: left; padding-left: 150px; padding-bottom:50px; padding-top:20px; background-image: url(../_static/nipy-logo-bg-138x120.png); background-repeat: no-repeat;">
<h1>NiBabel</h1>
<h3 style="margin-top:-5px;color:#2f83c8">Access a cacophony of neuro-imaging file formats</h3>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dicom_niftiheader.html" title="DICOM Tags in the NIfTI Header"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="siemens_csa.html" title="Siemens format DICOM with CSA header"
             accesskey="P">previous</a> |</li>
  <li><a href="http://nipy.org/">Community</a> |&nbsp;</li>
  <li><a href="../index.html">NiBabel Home</a> |&nbsp;</li>
  <li><a href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing list</a> |&nbsp;</li>
  <li><a href="legal.html">License</a> |&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="dicom.html" accesskey="U">DICOM concepts and implementations</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">SPM DICOM conversion</a><ul>
<li><a class="reference internal" href="#spm-dicom-dict-mat"><code class="docutils literal"><span class="pre">spm_dicom_dict.mat</span></code></a></li>
<li><a class="reference internal" href="#spm-dicom-headers-m"><code class="docutils literal"><span class="pre">spm_dicom_headers.m</span></code></a><ul>
<li><a class="reference internal" href="#file-opening">File opening</a></li>
<li><a class="reference internal" href="#tag-read-for-philips-integra">tag read for Philips Integra</a></li>
<li><a class="reference internal" href="#tag-length">Tag length</a></li>
<li><a class="reference internal" href="#sq-vr-type-sequnce-of-items-type"><code class="docutils literal"><span class="pre">SQ</span></code> VR type (Sequnce of items type)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spm-dicom-convert-m"><code class="docutils literal"><span class="pre">spm_dicom_convert.m</span></code></a><ul>
<li><a class="reference internal" href="#file-categorization">File categorization</a></li>
<li><a class="reference internal" href="#sorting-files-into-volumes">Sorting files into volumes</a><ul>
<li><a class="reference internal" href="#first-pass">First pass</a></li>
<li><a class="reference internal" href="#second-pass">Second pass</a></li>
<li><a class="reference internal" href="#final-check">Final check</a></li>
<li><a class="reference internal" href="#possible-volume-resort">Possible volume resort</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-dicom-volumes">Writing DICOM volumes</a><ul>
<li><a class="reference internal" href="#making-the-affine">Making the affine</a></li>
<li><a class="reference internal" href="#writing-the-voxel-data">Writing the voxel data</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="siemens_csa.html"
                        title="previous chapter">Siemens format DICOM with CSA header</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="dicom_niftiheader.html"
                        title="next chapter">DICOM Tags in the NIfTI Header</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/dicom/spm_dicom.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<p><img src="../_static/reggie.png" alt="Reggie -- the one" /></p>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="spm-dicom-conversion">
<span id="spm-dicom"></span><h1>SPM DICOM conversion<a class="headerlink" href="#spm-dicom-conversion" title="Permalink to this headline">¶</a></h1>
<p>These are some notes on the algorithms that <a class="reference external" href="http://www.fil.ion.ucl.ac.uk/spm">SPM</a> uses to convert from
<a class="reference external" href="http://medical.nema.org/">DICOM</a> to <a class="reference external" href="http://nifti.nimh.nih.gov">nifti</a>.  There are other notes in <a class="reference internal" href="dicom_mosaic.html#dicom-mosaic"><span class="std std-ref">Siemens mosaic format</span></a>.</p>
<p>The relevant SPM files are <code class="docutils literal"><span class="pre">spm_dicom_headers.m</span></code>,
<code class="docutils literal"><span class="pre">spm_dicom_dict.mat</span></code> and <code class="docutils literal"><span class="pre">spm_dicom_convert.m</span></code>.  These notes refer
the version in SPM8, as of around January 2010.</p>
<div class="section" id="spm-dicom-dict-mat">
<h2><code class="docutils literal"><span class="pre">spm_dicom_dict.mat</span></code><a class="headerlink" href="#spm-dicom-dict-mat" title="Permalink to this headline">¶</a></h2>
<p>This is obviously a Matlab <code class="docutils literal"><span class="pre">.mat</span></code> file.  It contains variables
<code class="docutils literal"><span class="pre">group</span></code> and <code class="docutils literal"><span class="pre">element</span></code>, and <code class="docutils literal"><span class="pre">values</span></code>, where <code class="docutils literal"><span class="pre">values</span></code> is a struct
array, one element per (group, element) pair, with fields <code class="docutils literal"><span class="pre">name</span></code> and
<code class="docutils literal"><span class="pre">vr</span></code> (the last a cell array).</p>
</div>
<div class="section" id="spm-dicom-headers-m">
<h2><code class="docutils literal"><span class="pre">spm_dicom_headers.m</span></code><a class="headerlink" href="#spm-dicom-headers-m" title="Permalink to this headline">¶</a></h2>
<p>Reads the given DICOM files into a struct.  It looks like this was
written by John Ahsburner (JA).  Relevant fixes are:</p>
<div class="section" id="file-opening">
<h3>File opening<a class="headerlink" href="#file-opening" title="Permalink to this headline">¶</a></h3>
<p>When opening the DICOM file, SPM (subfunction <code class="docutils literal"><span class="pre">readdicomfile</span></code>)</p>
<ol class="arabic simple">
<li>opens as little endian</li>
<li>reads 4 characters starting at pos 128</li>
<li>checks if these are <code class="docutils literal"><span class="pre">DICM</span></code>; if so then continues file read;
otherwise, tests to see if this is what SPM calls <em>truncated DICOM
file format</em> - lacking 128 byte lead in and <code class="docutils literal"><span class="pre">DICM</span></code> string:<ol class="arabic">
<li>Seeks to beginning of file</li>
<li>Reads two unsigned short values into <code class="docutils literal"><span class="pre">group</span></code> and <code class="docutils literal"><span class="pre">tag</span></code></li>
<li>If the (<code class="docutils literal"><span class="pre">group</span></code>, <code class="docutils literal"><span class="pre">element</span></code>) pair exist in
<code class="docutils literal"><span class="pre">spm_dicom_dict.mat</span></code>, then set file pointer to 0 and continue
read with <code class="docutils literal"><span class="pre">read_dicom</span></code> subfunction..</li>
<li>If <code class="docutils literal"><span class="pre">group</span></code> == 8 and <code class="docutils literal"><span class="pre">element</span></code> == 0, this is apparently the
signature for a &#8216;GE Twin+excite&#8217; for which JA notes there is no
documentation; set file pointer to 0 and continue read with
<code class="docutils literal"><span class="pre">read_dicom</span></code> subfunction.</li>
<li>Otherwise - crash out with error saying that this is not DICOM file.</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="tag-read-for-philips-integra">
<h3>tag read for Philips Integra<a class="headerlink" href="#tag-read-for-philips-integra" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">read_dicom</span></code> subfunction reads a tag, then has a loop during which
the tag is processed (by setting values into the return structure).  At
the end of the loop, it reads the next tag.  The loop breaks when the
current tag is empty, or is the item delimitation tag (group=FFFE,
element=E00D).</p>
<p>After it has broken out of the loop, if the last tag was (FFFE, E00D)
(item delimitation tag), and the tag length was not 0, then SPM sets the
file pointer back by 4 bytes from the current position.  JA comments
that he didn&#8217;t find that in the standard, but that it seemed to be
needed for the Philips Integra.</p>
</div>
<div class="section" id="tag-length">
<h3>Tag length<a class="headerlink" href="#tag-length" title="Permalink to this headline">¶</a></h3>
<p>Tag lengths as read in <code class="docutils literal"><span class="pre">read_tag</span></code> subfunction.  If current format is
explicit (as in &#8216;explicit little endian&#8217;):</p>
<ol class="arabic simple">
<li>For VR of x00x00, then group, element must be (FFFE, E00D) (item
delimitation tag). JA comments that GE &#8216;ImageDelimitationItem&#8217; has
no VR, just 4 0 bytes.  In this case the tag length is zero, and we
read another two bytes ahead.</li>
</ol>
<p>There&#8217;s a check for not-even tag length.  If not even:</p>
<ol class="arabic simple">
<li>4294967295 appears to be OK - and decoded as Inf for tag length.</li>
<li>13 appears to mean 10 and is reset to be 10</li>
<li>Any other odd number is not valid and gives a tag length of 0</li>
</ol>
</div>
<div class="section" id="sq-vr-type-sequnce-of-items-type">
<h3><code class="docutils literal"><span class="pre">SQ</span></code> VR type (Sequnce of items type)<a class="headerlink" href="#sq-vr-type-sequnce-of-items-type" title="Permalink to this headline">¶</a></h3>
<p>tag length of 13 set to tag length 10.</p>
</div>
</div>
<div class="section" id="spm-dicom-convert-m">
<h2><code class="docutils literal"><span class="pre">spm_dicom_convert.m</span></code><a class="headerlink" href="#spm-dicom-convert-m" title="Permalink to this headline">¶</a></h2>
<p>Written by John Ashburner and Jesper Andersson.</p>
<div class="section" id="file-categorization">
<h3>File categorization<a class="headerlink" href="#file-categorization" title="Permalink to this headline">¶</a></h3>
<p>SPM makes a special case of Siemens &#8216;spectroscopy images&#8217;.  These are
images that have &#8216;SOPClassUID&#8217; == &#8216;1.3.12.2.1107.5.9.1&#8217; and the private
tag of (29, 1210); for these it pulls out the affine, and writes a
volume of ones corresponding to the acquisition planes.</p>
<p>For images that are not spectroscopy:</p>
<ul class="simple">
<li>Discards images that do not have any of (&#8216;MR&#8217;, &#8216;PT&#8217;, &#8216;CT&#8217;) in &#8216;Modality&#8217; field.</li>
<li>Discards images lacking any of &#8216;StartOfPixelData&#8217;, &#8216;SamplesperPixel&#8217;,
&#8216;Rows&#8217;, &#8216;Columns&#8217;, &#8216;BitsAllocated&#8217;, &#8216;BitsStored&#8217;, &#8216;HighBit&#8217;,
&#8216;PixelRespresentation&#8217;</li>
<li>Discards images lacking any of &#8216;PixelSpacing&#8217;, &#8216;ImagePositionPatient&#8217;,
&#8216;ImageOrientationPatient&#8217; - presumably on the basis that SPM cannot
reconstruct the affine.</li>
<li>Fields &#8216;SeriesNumber&#8217;, &#8216;AcquisitionNumber&#8217; and &#8216;InstanceNumber&#8217; are
set to 1 if absent.</li>
</ul>
<p>Next SPM distinguishes between <a class="reference internal" href="dicom_mosaic.html#dicom-mosaic"><span class="std std-ref">Siemens mosaic format</span></a> and standard DICOM.</p>
<p>Mosaic images are those with the Siemens private tag:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0029</span><span class="p">,</span> <span class="mi">1009</span><span class="p">)</span> <span class="p">[</span><span class="n">CSA</span> <span class="n">Image</span> <span class="n">Header</span> <span class="n">Version</span><span class="p">]</span>          <span class="n">OB</span><span class="p">:</span> <span class="s1">&#39;20100114&#39;</span>
</pre></div>
</div>
<p>and a readable CSA header (see <a class="reference internal" href="dicom_mosaic.html#dicom-mosaic"><span class="std std-ref">Siemens mosaic format</span></a>), and with
non-empty fields from that header of &#8216;AcquisitionMatrixText&#8217;,
&#8216;NumberOfImagesInMosaic&#8217;, and with non-zero &#8216;NumberOfImagesInMosaic&#8217;.  The
rest are standard DICOM.</p>
<p>For converting mosaic format, see <a class="reference internal" href="dicom_mosaic.html#dicom-mosaic"><span class="std std-ref">Siemens mosaic format</span></a>.  The rest of this
page refers to standard (slice by slice) DICOMs.</p>
</div>
<div class="section" id="sorting-files-into-volumes">
<span id="spm-volume-sorting"></span><h3>Sorting files into volumes<a class="headerlink" href="#sorting-files-into-volumes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="first-pass">
<h4>First pass<a class="headerlink" href="#first-pass" title="Permalink to this headline">¶</a></h4>
<p>Take first header, put as start of first volume.   For each subsequent header:</p>
<ol class="arabic simple">
<li>Get <code class="docutils literal"><span class="pre">ICE_Dims</span></code> if present.  Look for Siemens &#8216;CSAImageHeaderInfo&#8217;,
check it has a &#8216;name&#8217; field, then pull dimensions out of &#8216;ICE_Dims&#8217;
field in form of 9 integers separated by &#8216;_&#8217;, where &#8216;X&#8217; in this
string replaced by &#8216;-1&#8217; - giving &#8216;ICE1&#8217;</li>
</ol>
<p>Then, for each currently identified volume:</p>
<ol class="arabic simple">
<li>If we have ICE1 above, and we do have &#8216;CSAIMageHeaderInfo&#8217;, with a
&#8216;name&#8217;, in the first header in this volume, then extract ICE dims in
the same way as above, for the first header in this volume, and check
whether all but ICE1[6:8] are the same as ICE2.  Set flag that all
ICE dims are identical for this volume.  Set this flag to True if we
did not have ICE1 or CSA information.</li>
<li>Match the current header to the current volume iff the following match:<ol class="arabic">
<li>SeriesNumber</li>
<li>Rows</li>
<li>Columns</li>
<li>ImageOrientationPatient (to tolerance of sum squared difference 1e-4)</li>
<li>PixelSpacing (to tolerance of sum squared difference 1e-4)</li>
<li>ICE dims as defined above</li>
<li>ImageType (iff imagetype exists in both)zv</li>
<li>SequenceName (iff sequencename exists in both)</li>
<li>SeriesInstanceUID (iff exists in both)</li>
<li>EchoNumbers (iff exists in both)</li>
</ol>
</li>
<li>If the current header matches the current volume, insert it there,
otherwise make a new volume for this header</li>
</ol>
</div>
<div class="section" id="second-pass">
<span id="spm-second-pass"></span><h4>Second pass<a class="headerlink" href="#second-pass" title="Permalink to this headline">¶</a></h4>
<p>We now have a list of volumes, where each volume is a list of headers
that may match.</p>
<p>For each volume:</p>
<ol class="arabic simple">
<li>Estimate the z direction cosine by (effectively) finding the cross
product of the x and y direction cosines contained in
&#8216;ImageOrientationPatient&#8217; - call this <code class="docutils literal"><span class="pre">z_dir_cos</span></code></li>
<li>For each header in this volume, get the z coordinate by taking the
dot product of the &#8216;ImagePositionPatient&#8217; vector and <code class="docutils literal"><span class="pre">z_dir_cos</span></code>
(see <a class="reference internal" href="dicom_orientation.html#dicom-z-from-slice"><span class="std std-ref">Working out the Z coordinates for a set of slices</span></a>).</li>
<li>Sort the headers according to this estimated z coordinate.</li>
<li>If this volume is more than one slice, and there are any slices with
the same z coordinate (as defined above), run the
<a class="reference internal" href="#dicom-img-resort"><span class="std std-ref">Possible volume resort</span></a> on this volume - on the basis that it may
have caught more than one volume-worth of slices.  Return one or more
volume&#8217;s worth of lists.</li>
</ol>
</div>
<div class="section" id="final-check">
<h4>Final check<a class="headerlink" href="#final-check" title="Permalink to this headline">¶</a></h4>
<p>For each volume, recalculate z coordinate as above.  Calculate the z
gaps.  Subtract the mean of the z gaps from all z gaps.  If the average of the
(gap-mean(gap)) is greater than 1e-4, then print a warning that there
are missing DICOM files.</p>
</div>
<div class="section" id="possible-volume-resort">
<span id="dicom-img-resort"></span><h4>Possible volume resort<a class="headerlink" href="#possible-volume-resort" title="Permalink to this headline">¶</a></h4>
<p>This step happens if there were volumes with slices having the same z
coordinate in the <a class="reference internal" href="#spm-second-pass"><span class="std std-ref">Second pass</span></a> step above.  The resort is on the
set of DICOM headers that were in the volume, for which there were
slices with identical z coordinates.  We&#8217;ll call the list of headers
that the routine is still working on - <code class="docutils literal"><span class="pre">work_list</span></code>.</p>
<ol class="arabic simple">
<li>If there is no &#8216;InstanceNumber&#8217; field for the first header in
<code class="docutils literal"><span class="pre">work_list</span></code>, bail out.</li>
<li>Print a message about the &#8216;AcquisitionNumber&#8217; not changing from
volume to volume.  This may be a relic from previous code, because
this version of SPM does not use the &#8216;AcquisitionNumber&#8217; field except
for making filenames.</li>
<li>Calculate the z coordinate as for <a class="reference internal" href="#spm-second-pass"><span class="std std-ref">Second pass</span></a>, for each
DICOM header.</li>
<li>Sort the headers by &#8216;InstanceNumber&#8217;</li>
<li>If any headers have the same &#8216;InstanceNumber&#8217;, then discard all but
the first header with the same number.  At this point the remaining
headers in <code class="docutils literal"><span class="pre">work_list</span></code> will have different &#8216;InstanceNumber&#8217;s, but
may have the same z coordinate.</li>
<li>Now sort by z coordinate</li>
<li>If there are <code class="docutils literal"><span class="pre">N</span></code> headers, make a <code class="docutils literal"><span class="pre">N</span></code> length vector of flags
<code class="docutils literal"><span class="pre">is_processed</span></code>, for which all values == False</li>
<li>Make an output list of header lists, call it <code class="docutils literal"><span class="pre">hdr_vol_out</span></code>, set to empty.</li>
<li>While there are still any False elements in <code class="docutils literal"><span class="pre">is_processed</span></code>:<ol class="arabic">
<li>Find first header for which corresponding <code class="docutils literal"><span class="pre">is_processed</span></code> is
False - call this <code class="docutils literal"><span class="pre">hdr_to_check</span></code></li>
<li>Collect indices (in <code class="docutils literal"><span class="pre">work_list</span></code>) of headers which have the same
z coordinate as <code class="docutils literal"><span class="pre">hdr_to_check</span></code>, call this list
<code class="docutils literal"><span class="pre">z_same_indices</span></code>.</li>
<li>Sort <code class="docutils literal"><span class="pre">work_list[z_same_indices]</span></code> by &#8216;InstanceNumber&#8217;</li>
<li>For each index in <code class="docutils literal"><span class="pre">z_same_indices</span></code> such that <code class="docutils literal"><span class="pre">i</span></code> indexes the
indices, and <code class="docutils literal"><span class="pre">zsind</span></code> is <code class="docutils literal"><span class="pre">z_same_indices[i]</span></code>: append header
corresponding to <code class="docutils literal"><span class="pre">zsind</span></code> to <code class="docutils literal"><span class="pre">hdr_vol_out[i]</span></code>.  This assumes
that the original <code class="docutils literal"><span class="pre">work_list</span></code> contained two or more volumes,
each with an identical set of z coordinates.</li>
<li>Set corresponding <code class="docutils literal"><span class="pre">is_processed</span></code> flag to True for all <code class="docutils literal"><span class="pre">z_same_indices</span></code>.</li>
</ol>
</li>
<li>Finally, if the headers in <code class="docutils literal"><span class="pre">work_list</span></code> have &#8216;InstanceNumber&#8217;s that
cannot be sorted to a sequence ascending in units of 1, or if any
of the lists in <code class="docutils literal"><span class="pre">hdr_vol_out</span></code> have different lengths, emit a
warning about missing DICOM files.</li>
</ol>
</div>
</div>
<div class="section" id="writing-dicom-volumes">
<h3>Writing DICOM volumes<a class="headerlink" href="#writing-dicom-volumes" title="Permalink to this headline">¶</a></h3>
<p>This means - writing DICOM volumes from standard (slice by slice) DICOM
datasets rather than <a class="reference internal" href="dicom_mosaic.html#dicom-mosaic"><span class="std std-ref">Siemens mosaic format</span></a>.</p>
<div class="section" id="making-the-affine">
<h4>Making the affine<a class="headerlink" href="#making-the-affine" title="Permalink to this headline">¶</a></h4>
<p>We need the (4,4) affine <span class="math">\(A\)</span> going from voxel (array) coordinates in the
DICOM pixel data, to mm coordinates in the <a class="reference internal" href="dicom_orientation.html#dicom-pcs"><span class="std std-ref">DICOM patient coordinate system</span></a>.</p>
<p>This section tries to explain how SPM achieves this, but I don&#8217;t
completely understand their method.  See <a class="reference internal" href="dicom_orientation.html#dicom-3d-affines"><span class="std std-ref">Getting a 3D affine from a DICOM slice or list of slices</span></a> for
what I believe to be a simpler explanation.</p>
<p>First define the constants, matrices and vectors as in
<a class="reference internal" href="dicom_orientation.html#dicom-affine-defs"><span class="std std-ref">DICOM affine Definitions</span></a>.</p>
<p><span class="math">\(N\)</span> is the number of slices in the volume.</p>
<p>Then define the following matrices:</p>
<div class="math">
\[ \begin{align}\begin{aligned}\begin{split}R = \left(\begin{smallmatrix}1 &amp; a &amp; 1 &amp; 0\\1 &amp; b &amp; 0 &amp; 1\\1 &amp; c &amp; 0 &amp; 0\\1 &amp; d &amp; 0 &amp; 0\end{smallmatrix}\right)\end{split}\\\begin{split}L = \left(\begin{smallmatrix}T^{1}_{{1}} &amp; e &amp; F_{{11}} \Delta{r} &amp; F_{{12}} \Delta{c}\\T^{1}_{{2}} &amp; f &amp; F_{{21}} \Delta{r} &amp; F_{{22}} \Delta{c}\\T^{1}_{{3}} &amp; g &amp; F_{{31}} \Delta{r} &amp; F_{{32}} \Delta{c}\\1 &amp; h &amp; 0 &amp; 0\end{smallmatrix}\right)\end{split}\end{aligned}\end{align} \]</div>
<p>For a volume with more than one slice (header), then <span class="math">\(a=1; b=1, c=N, d=1\)</span>. <span class="math">\(e, f, g\)</span> are the values from <span class="math">\(T^N\)</span>,
and <span class="math">\(h == 1\)</span>.</p>
<p>For a volume with only one slice (header) <span class="math">\(a=0, b=0, c=1, d=0\)</span> and <span class="math">\(e,
f, g, h\)</span> are <span class="math">\(n_1 \Delta{s}, n_2 \Delta{s}, n_3 \Delta{s}, 0\)</span>.</p>
<p>The full transform appears to be <span class="math">\(A_{spm} = R L^{-1}\)</span>.</p>
<p>Now, SPM, don&#8217;t forget, is working in terms of Matlab array indexing,
which starts at (1,1,1) for a three dimensional array, whereas DICOM
expects a (0,0,0) start (see <a class="reference internal" href="dicom_orientation.html#dicom-slice-affine"><span class="std std-ref">DICOM affine formula</span></a>).  In this
particular part of the SPM DICOM code, somewhat confusingly, the (0,0,0)
to (1,1,1) indexing is dealt with in the <span class="math">\(A\)</span> transform, rather than the
<code class="docutils literal"><span class="pre">analyze_to_dicom</span></code> transformation used by SPM in other places. So, the
transform <span class="math">\(A_{spm}\)</span> goes from (1,1,1) based voxel indices to mm.  To
get the (0, 0, 0)-based transform we want, we need to pre-apply the
transform to take 0-based voxel indices to 1-based voxel indices:</p>
<div class="math">
\[\begin{split}A = R L^{-1} \left(\begin{smallmatrix}1 &amp; 0 &amp; 0 &amp; 1\\0 &amp; 1 &amp; 0 &amp; 1\\0 &amp; 0 &amp; 1 &amp; 1\\0 &amp; 0 &amp; 0 &amp; 1\end{smallmatrix}\right)\end{split}\]</div>
<p>This formula with the definitions above result in the single and multi
slice formulae in <a class="reference internal" href="dicom_orientation.html#dicom-3d-affine-formulae"><span class="std std-ref">3D affine formulae</span></a>.</p>
<p>See <a class="reference download internal" href="../_downloads/spm_dicom_orient.py" download=""><code class="xref download docutils literal"><span class="pre">derivations/spm_dicom_orient.py</span></code></a> for the derivations and
some explanations.</p>
</div>
<div class="section" id="writing-the-voxel-data">
<h4>Writing the voxel data<a class="headerlink" href="#writing-the-voxel-data" title="Permalink to this headline">¶</a></h4>
<p>Just apply scaling and offset from &#8216;RescaleSlope&#8217; and &#8216;RescaleIntercept&#8217;
for each slice and write volume.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2006-2016, Matthew Brett, Michael Hanke, Eric Larson, Chris Markiewicz &lt;neuroimaging@python.org&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>